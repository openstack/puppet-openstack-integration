# handle puppet-ceph mimic branch and puppet-pacemaker 0.7.x
- pragma:
    implied-branches:
      - stable/rocky
      - stable/mimic
      - stable/0.7.x

- job:
    name: puppet-openstack-base
    pre-run: playbooks/prepare-node-common.yaml
    abstract: true
    vars:
      use_puppetlabs: false
    nodeset: ubuntu-bionic

- job:
    name: puppet-openstack-integration-base
    abstract: true
    parent: puppet-openstack-base
    required-projects:
      - name: openstack/openstack
      - name: openstack/puppet-aodh
        override-checkout: stable/rocky
      - name: openstack/puppet-barbican
        override-checkout: stable/rocky
      - name: openstack/puppet-ceilometer
        override-checkout: stable/rocky
      - name: openstack/puppet-ceph
        override-checkout: stable/mimic
      - name: openstack/puppet-cinder
        override-checkout: stable/rocky
      - name: openstack/puppet-cloudkitty
        override-checkout: stable/rocky
      - name: openstack/puppet-designate
        override-checkout: stable/rocky
      - name: openstack/puppet-ec2api
        override-checkout: stable/rocky
      - name: openstack/puppet-glance
        override-checkout: stable/rocky
      - name: openstack/puppet-gnocchi
        override-checkout: stable/rocky
      - name: openstack/puppet-heat
        override-checkout: stable/rocky
      - name: openstack/puppet-horizon
        override-checkout: stable/rocky
      - name: openstack/puppet-ironic
        override-checkout: stable/rocky
      - name: openstack/puppet-keystone
        override-checkout: stable/rocky
      - name: openstack/puppet-manila
        override-checkout: stable/rocky
      - name: openstack/puppet-mistral
        override-checkout: stable/rocky
      - name: openstack/puppet-monasca
        override-checkout: stable/rocky
      - name: x/puppet-modulesync-configs
        override-checkout: stable/rocky
      - name: openstack/puppet-murano
        override-checkout: stable/rocky
      - name: openstack/puppet-neutron
        override-checkout: stable/rocky
      - name: openstack/puppet-nova
        override-checkout: stable/rocky
      - name: openstack/puppet-octavia
        override-checkout: stable/rocky
      - name: openstack/puppet-openstack-cookiecutter
        override-checkout: stable/rocky
      - name: openstack/puppet-openstack-integration
        override-checkout: stable/rocky
      - name: openstack/puppet-openstack_extras
        override-checkout: stable/rocky
      - name: openstack/puppet-openstacklib
        override-checkout: stable/rocky
      - name: openstack/puppet-oslo
        override-checkout: stable/rocky
      - name: openstack/puppet-ovn
        override-checkout: stable/rocky
      - name: openstack/puppet-panko
        override-checkout: stable/rocky
      - name: openstack/puppet-qdr
        override-checkout: stable/rocky
      - name: openstack/puppet-sahara
        override-checkout: stable/rocky
      - name: openstack/puppet-swift
        override-checkout: stable/rocky
      - name: openstack/puppet-tacker
        override-checkout: stable/rocky
      - name: openstack/puppet-tempest
        override-checkout: stable/rocky
      - name: openstack/puppet-trove
        override-checkout: stable/rocky
      - name: openstack/puppet-vswitch
        override-checkout: stable/rocky
      - name: openstack/puppet-vitrage
        override-checkout: stable/rocky
      - name: openstack/puppet-watcher
        override-checkout: stable/rocky
      - name: openstack/puppet-zaqar
        override-checkout: stable/rocky
      - name: openstack/tempest
        override-checkout: stable/rocky

- job:
    name: puppet-openstack-integration-run-base
    parent: puppet-openstack-integration-base
    abstract: true
    pre-run: playbooks/prepare-node-integration.yaml
    run: playbooks/run-integration-tests.yaml
    post-run: playbooks/upload-logs.yaml
    timeout: 5400
    irrelevant-files:
      - ^.*\.md$
      - ^doc/.*$
      - ^metadata.json$
      - ^releasenotes/.*$
      - ^spec/.*$
      - ^requirements.txt$
      - ^test-requirements.txt$
      - ^LICENSE$
      - ^.gitignore$
    roles:
      - zuul: zuul/zuul-jobs
    # NOTE(tobasco): The ceph variable must be provided with a default here
    # or zuul will complain when it tries to render the run-integration-tests template.
    vars:
      ceph: luminous

- job:
    name: puppet-openstack-integration-4
    parent: puppet-openstack-integration-run-base
    abstract: true
    vars:
      puppet: 4

- job:
    name: puppet-openstack-integration-4-scenario001
    parent: puppet-openstack-integration-4
    abstract: true
    vars:
      scenario: scenario001
      ceph: luminous

- job:
    name: puppet-openstack-integration-4-scenario001-tempest-debian-stable-luminous
    parent: puppet-openstack-integration-4-scenario001
    nodeset: debian-stable

- job:
    name: puppet-openstack-integration-4-scenario002
    parent: puppet-openstack-integration-4
    abstract: true
    vars:
      scenario: scenario002

- job:
    name: puppet-openstack-integration-4-scenario002-tempest-debian-stable
    parent: puppet-openstack-integration-4-scenario002
    nodeset: debian-stable

- job:
    name: puppet-openstack-integration-4-scenario003
    parent: puppet-openstack-integration-4
    abstract: true
    vars:
      scenario: scenario003

- job:
    name: puppet-openstack-integration-4-scenario003-tempest-debian-stable
    parent: puppet-openstack-integration-4-scenario003
    nodeset: debian-stable

- job:
    name: puppet-openstack-integration-4-scenario004
    parent: puppet-openstack-integration-4
    abstract: true
    vars:
      scenario: scenario004
      ceph: mimic

- job:
    name: puppet-openstack-integration-4-scenario004-tempest-debian-stable-luminous
    parent: puppet-openstack-integration-4-scenario004
    nodeset: debian-stable
    vars:
      ceph: luminous

- job:
    name: puppet-openstack-integration-5
    parent: puppet-openstack-integration-run-base
    abstract: true
    vars:
      puppet: 5

- job:
    name: puppet-openstack-integration-5-scenario001
    parent: puppet-openstack-integration-5
    abstract: true
    vars:
      scenario: scenario001
      ceph: luminous

- job:
    name: puppet-openstack-integration-5-scenario001-tempest-ubuntu-bionic-mimic
    parent: puppet-openstack-integration-5-scenario001
    nodeset: ubuntu-bionic
    voting: false
    vars:
      ceph: mimic

- job:
    name: puppet-openstack-integration-5-scenario001-tempest-centos-7-luminous
    parent: puppet-openstack-integration-5-scenario001
    nodeset: centos-7

- job:
    name: puppet-openstack-integration-5-scenario001-tempest-debian-stable-luminous
    parent: puppet-openstack-integration-5-scenario001
    nodeset: debian-stable

- job:
    name: puppet-openstack-integration-5-scenario002
    parent: puppet-openstack-integration-5
    abstract: true
    vars:
      scenario: scenario002

- job:
    name: puppet-openstack-integration-5-scenario002-tempest-ubuntu-bionic
    parent: puppet-openstack-integration-5-scenario002
    nodeset: ubuntu-bionic
    voting: false
    # NOTE(tobasco): Should normally not really pass mimic ceph var here but since
    # luminous is not packaged for Bionic repos.pp will fail otherwise.
    vars:
      ceph: mimic

- job:
    name: puppet-openstack-integration-5-scenario002-tempest-centos-7
    parent: puppet-openstack-integration-5-scenario002
    nodeset: centos-7

- job:
    name: puppet-openstack-integration-5-scenario002-tempest-debian-stable
    parent: puppet-openstack-integration-5-scenario002
    nodeset: debian-stable

- job:
    name: puppet-openstack-integration-5-scenario003
    parent: puppet-openstack-integration-5
    abstract: true
    vars:
      scenario: scenario003

- job:
    name: puppet-openstack-integration-5-scenario003-tempest-ubuntu-bionic
    parent: puppet-openstack-integration-5-scenario003
    nodeset: ubuntu-bionic
    voting: false
    # NOTE(tobasco): Should normally not really pass mimic ceph var here but since
    # luminous is not packaged for Bionic repos.pp will fail otherwise.
    vars:
      ceph: mimic

- job:
    name: puppet-openstack-integration-5-scenario003-tempest-centos-7
    parent: puppet-openstack-integration-5-scenario003
    nodeset: centos-7

- job:
    name: puppet-openstack-integration-5-scenario003-tempest-debian-stable
    parent: puppet-openstack-integration-5-scenario003
    nodeset: debian-stable

- job:
    name: puppet-openstack-integration-5-scenario004
    parent: puppet-openstack-integration-5
    abstract: true
    vars:
      scenario: scenario004
      ceph: mimic

- job:
    name: puppet-openstack-integration-5-scenario004-tempest-ubuntu-bionic-mimic
    parent: puppet-openstack-integration-5-scenario004
    nodeset: ubuntu-bionic
    voting: false
    # NOTE(tobasco): Should normally not really pass mimic ceph var here but since
    # luminous is not packaged for Bionic repos.pp will fail otherwise.
    vars:
      ceph: mimic

- job:
    name: puppet-openstack-integration-5-scenario004-tempest-centos-7-mimic
    parent: puppet-openstack-integration-5-scenario004
    nodeset: centos-7

- job:
    name: puppet-openstack-integration-5-scenario004-tempest-debian-stable-luminous
    parent: puppet-openstack-integration-5-scenario004
    nodeset: debian-stable
    vars:
      ceph: luminous

- project-template:
    name: puppet-openstack-integration-jobs-all
    check:
      jobs:
        - puppet-openstack-integration-5-scenario001-tempest-centos-7-luminous
        - puppet-openstack-integration-5-scenario002-tempest-centos-7
        - puppet-openstack-integration-5-scenario003-tempest-centos-7
        - puppet-openstack-integration-5-scenario004-tempest-centos-7-mimic
        - puppet-openstack-integration-5-scenario001-tempest-ubuntu-bionic-mimic
        - puppet-openstack-integration-5-scenario002-tempest-ubuntu-bionic
        - puppet-openstack-integration-5-scenario003-tempest-ubuntu-bionic
        - puppet-openstack-integration-5-scenario004-tempest-ubuntu-bionic-mimic
        - puppet-openstack-integration-4-scenario001-tempest-debian-stable-luminous:
            voting: false
        - puppet-openstack-integration-4-scenario002-tempest-debian-stable:
            voting: false
        - puppet-openstack-integration-4-scenario003-tempest-debian-stable:
            voting: false
        - puppet-openstack-integration-4-scenario004-tempest-debian-stable-luminous:
            voting: false
    gate:
      jobs:
        - puppet-openstack-integration-5-scenario001-tempest-centos-7-luminous
        - puppet-openstack-integration-5-scenario002-tempest-centos-7
        - puppet-openstack-integration-5-scenario003-tempest-centos-7
        - puppet-openstack-integration-5-scenario004-tempest-centos-7-mimic
    experimental:
      jobs:
        - puppet-openstack-integration-5-scenario001-tempest-debian-stable-luminous
        - puppet-openstack-integration-5-scenario002-tempest-debian-stable
        - puppet-openstack-integration-5-scenario003-tempest-debian-stable
        - puppet-openstack-integration-5-scenario004-tempest-debian-stable-luminous

- project-template:
    name: puppet-openstack-integration-jobs-scenario001
    check:
      jobs:
        - puppet-openstack-integration-5-scenario001-tempest-ubuntu-bionic-mimic
        - puppet-openstack-integration-5-scenario001-tempest-centos-7-luminous
        - puppet-openstack-integration-4-scenario001-tempest-debian-stable-luminous:
            voting: false
    gate:
      jobs:
        - puppet-openstack-integration-5-scenario001-tempest-centos-7-luminous
    experimental:
      jobs:
        - puppet-openstack-integration-5-scenario001-tempest-debian-stable-luminous

- project-template:
    name: puppet-openstack-integration-jobs-scenario002
    check:
      jobs:
        - puppet-openstack-integration-5-scenario002-tempest-ubuntu-bionic
        - puppet-openstack-integration-5-scenario002-tempest-centos-7
        - puppet-openstack-integration-4-scenario002-tempest-debian-stable:
            voting: false
    gate:
      jobs:
        - puppet-openstack-integration-5-scenario002-tempest-centos-7
    experimental:
      jobs:
        - puppet-openstack-integration-5-scenario002-tempest-debian-stable

- project-template:
    name: puppet-openstack-integration-jobs-scenario003
    check:
      jobs:
        - puppet-openstack-integration-5-scenario003-tempest-ubuntu-bionic
        - puppet-openstack-integration-5-scenario003-tempest-centos-7
        - puppet-openstack-integration-4-scenario003-tempest-debian-stable:
            voting: false
    gate:
      jobs:
        - puppet-openstack-integration-4-scenario003-tempest-centos-7
        - puppet-openstack-integration-5-scenario003-tempest-centos-7
    experimental:
      jobs:
        - puppet-openstack-integration-5-scenario003-tempest-debian-stable

- project-template:
    name: puppet-openstack-integration-jobs-scenario004
    check:
      jobs:
        - puppet-openstack-integration-5-scenario004-tempest-ubuntu-bionic-mimic
        - puppet-openstack-integration-5-scenario004-tempest-centos-7-mimic
        - puppet-openstack-integration-4-scenario004-tempest-debian-stable-luminous:
            voting: false
    gate:
      jobs:
        - puppet-openstack-integration-5-scenario004-tempest-centos-7-mimic
    experimental:
      jobs:
        - puppet-openstack-integration-5-scenario004-tempest-debian-stable-luminous

- job:
    name: puppet-openstack-module-base
    parent: puppet-openstack-base
    pre-run: playbooks/prepare-node-unit.yaml

- job:
    name: puppet-openstack-lint
    parent: puppet-openstack-module-base
    run: playbooks/run-lint-tests.yaml
    irrelevant-files:
      - ^doc/.*$
      - ^etc/.*$
      - ^releasenotes/.*$
      - ^requirements.txt$
      - ^test-requirements.txt$

- job:
    name: puppet-openstack-syntax
    parent: puppet-openstack-module-base
    run: playbooks/run-syntax-tests.yaml
    irrelevant-files:
      - ^.*\.md$
      - ^.*\.rst$
      - ^doc/.*$
      - ^etc/.*$
      - ^metadata.json$
      - ^releasenotes/.*$
      - ^requirements.txt$
      - ^test-requirements.txt$
      - ^LICENSE$
      - ^.gitignore$

- job:
    name: puppet-openstack-syntax-4
    parent: puppet-openstack-syntax
    vars:
      puppet: 4

- job:
    name: puppet-openstack-syntax-5
    parent: puppet-openstack-syntax
    vars:
      puppet: 5

- job:
    name: puppet-openstack-unit-base
    parent: puppet-openstack-integration-base
    run: playbooks/run-unit-tests.yaml
    pre-run: playbooks/prepare-node-unit.yaml
    timeout: 3600
    irrelevant-files:
      - ^.*\.md$
      - ^.*\.rst$
      - ^doc/.*$
      - ^etc/.*$
      - ^metadata.json$
      - ^releasenotes/.*$
      - ^requirements.txt$
      - ^test-requirements.txt$
      - ^spec/acceptance/.*$
      - ^LICENSE$
      - ^.gitignore$

- job:
    name: puppet-openstack-unit-4.8-centos-7
    parent: puppet-openstack-unit-base
    nodeset: centos-7
    vars:
      puppet_gem_version: 4.8

- job:
    name: puppet-openstack-unit-5.5-centos-7
    parent: puppet-openstack-unit-base
    nodeset: centos-7
    vars:
      puppet_gem_version: 5.5

- project-template:
    name: puppet-openstack-module-unit-jobs
    check:
      jobs:
        - puppet-openstack-unit-4.8-centos-7
        - puppet-openstack-unit-5.5-centos-7
    gate:
      jobs:
        - puppet-openstack-unit-4.8-centos-7
        - puppet-openstack-unit-5.5-centos-7

- project-template:
    name: puppet-openstack-check-jobs
    check:
      jobs:
        - puppet-openstack-lint
        - puppet-openstack-syntax-4
        - puppet-openstack-syntax-5
    gate:
      jobs:
        - puppet-openstack-lint
        - puppet-openstack-syntax-4
        - puppet-openstack-syntax-5

- project:
    templates:
      - puppet-openstack-check-jobs
      - puppet-openstack-integration-jobs-all

- job:
    name: puppet-openstack-beaker-run-base
    parent: puppet-openstack-integration-base
    abstract: true
    pre-run: playbooks/prepare-node-beaker.yaml
    post-run: playbooks/upload-logs.yaml
    run: playbooks/run-beaker-tests.yaml
    timeout: 5400
    irrelevant-files:
      - ^.*\.md$
      - ^doc/.*$
      - ^releasenotes/.*$
      - ^spec/unit/.*$
      - ^spec/classes/.*$
      - ^spec/defines/.*$
      - ^requirements.txt$
      - ^test-requirements.txt$
      - ^metadata.json$
      - ^LICENSE$
      - ^.gitignore$

- job:
    name: puppet-openstack-beaker-centos-7
    parent: puppet-openstack-beaker-run-base
    nodeset: centos-7
    vars:
      nodepool_type: centos7

- job:
    name: puppet-openstack-beaker-ubuntu-bionic
    parent: puppet-openstack-beaker-run-base
    nodeset: ubuntu-bionic
    vars:
      nodepool_type: bionic

- project-template:
    name: puppet-openstack-beaker-jobs
    check:
      jobs:
        - puppet-openstack-beaker-centos-7
        - puppet-openstack-beaker-ubuntu-bionic
    gate:
      jobs:
        - puppet-openstack-beaker-centos-7
        - puppet-openstack-beaker-ubuntu-bionic

- job:
    name: puppet-openstack-libraries-puppet-beaker-rspec-centos-7
    parent: puppet-openstack-integration-base
    pre-run: playbooks/prepare-node-beaker.yaml
    post-run: playbooks/upload-logs.yaml
    run: playbooks/run-libraries-beaker-tests.yaml
    timeout: 3600
    nodeset: centos-7
    irrelevant-files:
      - ^.*\.md$
      - ^.*\.rst$
      - ^doc/.*$
      - ^etc/.*$
      - ^metadata.json$
      - ^releasenotes/.*$
      - ^test-requirements.txt$
      - ^LICENSE$
      - ^.gitignore$
    vars:
      nodepool_type: centos7

- job:
    name: puppet-openstack-libraries-puppet-beaker-rspec-ubuntu-bionic
    parent: puppet-openstack-integration-base
    pre-run: playbooks/prepare-node-beaker.yaml
    post-run: playbooks/upload-logs.yaml
    run: playbooks/run-libraries-beaker-tests.yaml
    timeout: 3600
    nodeset: ubuntu-bionic
    irrelevant-files:
      - ^.*\.md$
      - ^.*\.rst$
      - ^doc/.*$
      - ^etc/.*$
      - ^metadata.json$
      - ^releasenotes/.*$
      - ^test-requirements.txt$
      - ^LICENSE$
      - ^.gitignore$
    vars:
      nodepool_type: bionic

- job:
    name: puppet-openstack-libraries-puppet-lint-centos-7
    parent: puppet-openstack-integration-base
    run: playbooks/run-libraries-lint-tests.yaml
    pre-run: playbooks/prepare-node-unit.yaml
    timeout: 3600
    nodeset: centos-7

- job:
    name: puppet-openstack-libraries-puppet-syntax
    parent: puppet-openstack-integration-base
    run: playbooks/run-libraries-syntax-tests.yaml
    pre-run: playbooks/prepare-node-unit.yaml
    timeout: 3600
    irrelevant-files:
      - ^.*\.md$
      - ^.*\.rst$
      - ^doc/.*$
      - ^etc/.*$
      - ^metadata.json$
      - ^releasenotes/.*$
      - ^test-requirements.txt$
      - ^LICENSE$
      - ^.gitignore$

- job:
    name: puppet-openstack-libraries-puppet-syntax-4-centos-7
    parent: puppet-openstack-libraries-puppet-syntax
    nodeset: centos-7
    vars:
      puppet: 4

- job:
    name: puppet-openstack-libraries-puppet-syntax-5-centos-7
    parent: puppet-openstack-libraries-puppet-syntax
    nodeset: centos-7
    vars:
      puppet: 5

- job:
    name: puppet-openstack-libraries-puppet-unit-centos-7
    parent: puppet-openstack-integration-base
    run: playbooks/run-libraries-unit-tests.yaml
    pre-run: playbooks/prepare-node-unit.yaml
    timeout: 3600
    nodeset: centos-7
    irrelevant-files:
      - ^.*\.md$
      - ^.*\.rst$
      - ^doc/.*$
      - ^etc/.*$
      - ^metadata.json$
      - ^releasenotes/.*$
      - ^test-requirements.txt$
      - ^LICENSE$
      - ^.gitignore$

- job:
    name: puppet-openstack-libraries-puppet-unit-4.8-centos-7
    parent: puppet-openstack-libraries-puppet-unit-centos-7
    vars:
      puppet_gem_version: 4.8

- job:
    name: puppet-openstack-libraries-puppet-unit-5.5-centos-7
    parent: puppet-openstack-libraries-puppet-unit-centos-7
    vars:
      puppet_gem_version: 5.5

- job:
    name: tripleo-puppet-ci-centos-7-undercloud-containers
    parent: tripleo-ci-centos-7-undercloud-containers
    irrelevant-files:
      - ^.*\.md$
      - ^.*\.rst$
      - ^doc/.*$
      - ^etc/.*$
      - ^metadata.json$
      - ^releasenotes/.*$
      - ^test-requirements.txt$
      - ^LICENSE$
      - ^.gitignore$
    voting: false

- job:
    name: tripleo-puppet-ci-centos-7-undercloud-oooq
    parent: tripleo-ci-centos-7-undercloud-oooq
    irrelevant-files:
      - ^.*\.md$
      - ^.*\.rst$
      - ^doc/.*$
      - ^etc/.*$
      - ^metadata.json$
      - ^releasenotes/.*$
      - ^test-requirements.txt$
      - ^LICENSE$
      - ^.gitignore$
    voting: false

- project-template:
    name: tripleo-puppet-undercloud
    check:
      jobs:
        - tripleo-puppet-ci-centos-7-undercloud-oooq
        - tripleo-puppet-ci-centos-7-undercloud-containers


- project-template:
    name: puppet-openstack-library-jobs
    check:
      jobs:
        - puppet-openstack-libraries-puppet-lint-centos-7
        - puppet-openstack-libraries-puppet-syntax-4-centos-7
        - puppet-openstack-libraries-puppet-syntax-5-centos-7
        - puppet-openstack-libraries-puppet-unit-4.8-centos-7
        - puppet-openstack-libraries-puppet-unit-5.5-centos-7
        - puppet-openstack-libraries-puppet-beaker-rspec-centos-7
        - puppet-openstack-libraries-puppet-beaker-rspec-ubuntu-bionic
    gate:
      jobs:
        - puppet-openstack-libraries-puppet-lint-centos-7
        - puppet-openstack-libraries-puppet-syntax-4-centos-7
        - puppet-openstack-libraries-puppet-syntax-5-centos-7
        - puppet-openstack-libraries-puppet-unit-4.8-centos-7
        - puppet-openstack-libraries-puppet-unit-5.5-centos-7
        - puppet-openstack-libraries-puppet-beaker-rspec-centos-7
        - puppet-openstack-libraries-puppet-beaker-rspec-ubuntu-bionic
